"""Git utilities for the MCP server"""
import subprocess
import os
from pathlib import Path

def run_git_command(command: list, cwd: str = "/Users/diegowahl/mcp-server") -> str:
    """Run a git command safely"""
    try:
        # Check if we're in a git repository
        result = subprocess.run(
            ["git", "rev-parse", "--git-dir"],
            cwd=cwd,
            capture_output=True,
            text=True,
            timeout=10
        )
        if result.returncode != 0:
            return f"Error: Not in a git repository (checked {cwd})"
        
        # Run the actual command
        result = subprocess.run(
            command,
            cwd=cwd,
            capture_output=True,
            text=True,
            timeout=30
        )
        
        if result.returncode == 0:
            return result.stdout.strip() if result.stdout else "Command completed successfully"
        else:
            return f"Git error: {result.stderr.strip()}"
            
    except subprocess.TimeoutExpired:
        return "Error: Git command timed out"
    except Exception as e:
        return f"Error running git command: {str(e)}"

def get_git_status() -> str:
    """Get the current git status"""
    result = run_git_command(["git", "status", "--porcelain", "-b"])
    if result.startswith("Error"):
        return result
    
    lines = result.split('\n')
    if not lines or not lines[0]:
        return "Working directory clean"
    
    # Parse the branch info and changes
    output = []
    for line in lines:
        if line.startswith('##'):
            branch_info = line[3:]
            output.append(f"Branch: {branch_info}")
        elif line:
            status = line[:2]
            filename = line[3:]
            status_map = {
                'M ': 'Modified (staged)',
                ' M': 'Modified (unstaged)',
                'A ': 'Added',
                'D ': 'Deleted (staged)',
                ' D': 'Deleted (unstaged)',
                '??': 'Untracked',
                'R ': 'Renamed',
                'C ': 'Copied'
            }
            status_desc = status_map.get(status, f'Status: {status}')
            output.append(f"{status_desc}: {filename}")
    
    return '\n'.join(output)

def get_git_branch() -> str:
    """Get current branch and list all branches"""
    current = run_git_command(["git", "branch", "--show-current"])
    if current.startswith("Error"):
        return current
    
    all_branches = run_git_command(["git", "branch", "-a"])
    if all_branches.startswith("Error"):
        return f"Current branch: {current}\nError getting all branches: {all_branches}"
    
    return f"Current branch: {current}\n\nAll branches:\n{all_branches}"

def get_git_log(limit: int = 10) -> str:
    """Get recent commit history"""
    command = ["git", "log", f"--max-count={limit}", "--oneline", "--graph", "--decorate"]
    return run_git_command(command)
